{% extends 'base.html' %}

{% block title %}Wahlpflichtgruppen - Lernmanager{% endblock %}

{% block content %}
<div class="flex flex-between flex-center mb-2">
    <h1>üéØ Wahlpflichtgruppen</h1>
</div>

<p class="text-muted mb-2">Wahlpflichtgruppen enthalten mehrere Aufgaben, von denen Sch√ºler eine ausw√§hlen und abschlie√üen m√ºssen.</p>

<!-- Create new group -->
<div class="card mb-2">
    <div class="card-header">+ Neue Wahlpflichtgruppe</div>
    <form method="POST" action="{{ url_for('admin_wahlpflicht_neu') }}">
        <div class="grid grid-2">
            <div class="form-group">
                <label for="name">Name</label>
                <input type="text" id="name" name="name" class="form-control" placeholder="z.B. Projektarbeit Klasse 7" required>
            </div>
            <div class="form-group">
                <label for="fach">Fach</label>
                <select id="fach" name="fach" class="form-control" required>
                    {% for subject in subjects %}
                    <option value="{{ subject }}">{{ subject }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="stufe">Stufe</label>
                <select id="stufe" name="stufe" class="form-control" required>
                    {% for level in levels %}
                    <option value="{{ level }}">{{ level }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="beschreibung">Beschreibung (optional)</label>
                <input type="text" id="beschreibung" name="beschreibung" class="form-control" placeholder="Kurze Beschreibung...">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Gruppe erstellen</button>
    </form>
</div>

<!-- Existing groups -->
{% if gruppen %}
{% for gruppe in gruppen %}
<div class="card mb-2">
    <div class="card-header flex flex-between flex-center">
        <div>
            <strong>{{ gruppe.name }}</strong>
            <span class="badge badge-secondary ml-1">{{ gruppe.fach }}</span>
            <span class="badge badge-secondary">{{ gruppe.stufe }}</span>
        </div>
        <form method="POST" action="{{ url_for('admin_wahlpflicht_loeschen', gruppe_id=gruppe.id) }}" onsubmit="return confirm('Gruppe wirklich l√∂schen?');">
            <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è L√∂schen</button>
        </form>
    </div>

    {% if gruppe.beschreibung %}
    <p class="text-muted mb-1">{{ gruppe.beschreibung }}</p>
    {% endif %}

    <!-- Tasks in this group -->
    <div class="mb-2">
        <strong>Aufgaben in dieser Gruppe:</strong>
        {% if gruppen_tasks[gruppe.id] %}
        <ul class="mt-1">
            {% for task in gruppen_tasks[gruppe.id] %}
            <li class="flex flex-between flex-center mb-05">
                <span>
                    <a href="{{ url_for('admin_aufgabe_detail', task_id=task.id) }}">{{ task.name }}</a>
                    <small class="text-muted">({{ task.fach }} {{ task.stufe }})</small>
                </span>
                <form method="POST" action="{{ url_for('admin_wahlpflicht_aufgabe_entfernen', gruppe_id=gruppe.id, task_id=task.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-secondary">Entfernen</button>
                </form>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted mt-1">Noch keine Aufgaben zugeordnet.</p>
        {% endif %}
    </div>

    <!-- Add task to group -->
    <form method="POST" action="{{ url_for('admin_wahlpflicht_aufgabe_hinzufuegen', gruppe_id=gruppe.id) }}" class="flex gap-1">
        <select name="task_id" class="form-control" required>
            <option value="">-- Aufgabe ausw√§hlen --</option>
            {% for task in tasks %}
            {% if task.id not in gruppen_tasks[gruppe.id]|map(attribute='id')|list %}
            <option value="{{ task.id }}">{{ task.fach }} ({{ task.stufe }}): {{ task.name }}</option>
            {% endif %}
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-secondary">Hinzuf√ºgen</button>
    </form>
</div>
{% endfor %}
{% else %}
<div class="card text-center text-muted">
    <p>Noch keine Wahlpflichtgruppen vorhanden.</p>
</div>
{% endif %}
{% endblock %}
